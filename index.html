<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>WHERE'S MY SUPYBARA?🍉</title>

  <!-- Open Graph 메타 -->
  <meta property="og:title" content="WHERE'S MY SUPYBARA?🍉">
  <meta property="og:image" content="https://devcshin.github.io/ys_compass/spbr.png">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://devcshin.github.io/ys_compass/">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      text-align:center;
      font-family:sans-serif;
      margin:0;
      padding:20px;
    }
    #arrow {
      font-size: 40px;
      width: 40vw;
      max-width: 300px;
      transition: transform 0.2s linear;
      display: inline-block;
    }
    #targetCoord {
      font-size: 4vw;
      max-font-size: 20px;
      margin: 5px 0 15px 0;
      word-break: break-word;
    }
    #info {
      font-size: 4vw;
      max-font-size: 18px;
      margin-top:10px;
    }
    button {
      font-size: 4vw;
      max-font-size: 18px;
      padding: 8px 16px;
      margin-top: 10px;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>🧭 실시간 수피바라의 방향 🍉</h2>
  <div id="targetCoord">목표 좌표 불러오는 중...</div>
  <div id="arrow">⬆️</div>
  <div id="info"></div>
  <button onclick="requestPermission()">🍏 iOS 권한 요청</button>

<script>
  // ===== Firebase 설정 (본인 프로젝트로 변경) =====
  const firebaseConfig = {
    apiKey: "AIzaSyAOHwpN6pTIgFK2RkxYMNoCnkXaotTg6bY",
    authDomain: "retrofittester-4f36c.firebaseapp.com",
    databaseURL: "https://retrofittester-4f36c-default-rtdb.firebaseio.com",
    projectId: "retrofittester-4f36c",
    storageBucket: "retrofittester-4f36c.firebasestorage.app",
    messagingSenderId: "398490449949",
    appId: "1:398490449949:web:65fee5344c68ccb078aef4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let target = { lat: 37.5662952, lng: 126.9779451 }; // 초기값 서울시청
  let currentPos = null;
  let currentHeading = 0;

  // ===== iOS 권한 요청 =====
  function requestPermission() {
    if (DeviceOrientationEvent.requestPermission) {
      DeviceOrientationEvent.requestPermission().then(res => {
        if (res === "granted") {
          window.addEventListener("deviceorientationabsolute", handleOrientation, true);
        }
      });
    }
  }

  // ===== Android 여부 체크 =====
  const isAndroid = /Android/i.test(navigator.userAgent);

  // ===== 토스트 메시지 =====
  function showToast(message) {
    let existing = document.getElementById("toastMsg");
    if (existing) existing.remove();

    const toast = document.createElement("div");
    toast.id = "toastMsg";
    toast.innerText = message;
    toast.style.position = "fixed";
    toast.style.bottom = "50px";
    toast.style.left = "50%";
    toast.style.transform = "translateX(-50%)";
    toast.style.backgroundColor = "rgba(0,0,0,0.7)";
    toast.style.color = "#fff";
    toast.style.padding = "10px 20px";
    toast.style.borderRadius = "10px";
    toast.style.fontSize = "16px";
    toast.style.zIndex = "9999";
    toast.style.opacity = "0";
    toast.style.transition = "opacity 0.3s";
    document.body.appendChild(toast);

    setTimeout(() => { toast.style.opacity = "1"; }, 50);
    setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }

  // ===== 위치 업로드 (Android 전용) =====
  function uploadLocation() {
    if (!currentPos) return;
    firebase.database().ref("locations/userA").set({
      lat: currentPos.lat,
      lng: currentPos.lng
    }).then(() => {
      console.log("Android 위치 업로드 완료:", currentPos.lat, currentPos.lng);
      showToast("위치 업데이트 완료 ✅");
    }).catch(err => console.error(err));
  }

  // ===== 내 위치 업데이트 =====
  navigator.geolocation.watchPosition(pos => {
    currentPos = {
      lat: pos.coords.latitude,
      lng: pos.coords.longitude
    };

    if (isAndroid) uploadLocation();
  }, err => console.error(err), { enableHighAccuracy:true });

  // ===== Firebase에서 실시간 목표 좌표 가져오기 =====
  const targetRef = db.ref("locations/userA");
  targetRef.on("value", snapshot => {
    const data = snapshot.val();
    if (data && data.lat && data.lng) {
      target.lat = data.lat;
      target.lng = data.lng;
      document.getElementById("targetCoord").innerText = 
        `목표 좌표: (${target.lat.toFixed(5)}, ${target.lng.toFixed(5)})`;
    } else {
      document.getElementById("targetCoord").innerText = "목표 좌표 없음";
    }
  });

  // ===== 기기 방향 이벤트 =====
  window.addEventListener("deviceorientationabsolute", handleOrientation, true);
  window.addEventListener("deviceorientation", handleOrientation, true);

  function handleOrientation(event) {
    let heading;
    if (event.webkitCompassHeading) {
      heading = event.webkitCompassHeading;
    } else if (event.absolute && event.alpha !== null) {
      heading = 360 - event.alpha;
    }
    if (heading !== undefined) {
      currentHeading = heading;
      updateArrow();
    }
  }

  function updateArrow() {
    if (!currentPos || !target.lat) return;
    const bearing = computeBearing(currentPos, target);
    let diff = (bearing - currentHeading + 360) % 360;
    document.getElementById("arrow").style.transform = `rotate(${diff}deg)`;
    document.getElementById("info").innerText = 
      `나침반:${currentHeading.toFixed(1)}° / 목표:${bearing.toFixed(1)}° / 화살표:${diff.toFixed(1)}°`;
  }

  function computeBearing(from, to) {
    const φ1 = from.lat * Math.PI/180;
    const φ2 = to.lat * Math.PI/180;
    const Δλ = (to.lng - from.lng) * Math.PI/180;
    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1)*Math.sin(φ2) -
              Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
    const θ = Math.atan2(y, x);
    return (θ*180/Math.PI + 360) % 360;
  }
</script>
</body>
</html>
