<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>WHERE'S MY SUPYBARA?ğŸ‰</title>

  <!-- Open Graph ë©”íƒ€ -->
  <meta property="og:title" content="WHERE'S MY SUPYBARA?ğŸ‰">
  <meta property="og:image" content="https://devcshin.github.io/ys_compass/spbr.png">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://devcshin.github.io/ys_compass/">

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    body {
      text-align:center;
      font-family:sans-serif;
      margin:0;
      padding:20px;
    }
    #arrow {
      font-size: 40px;
      width: 40vw;
      max-width: 300px;
      transition: transform 0.2s linear;
      display: inline-block;
    }
    #targetCoord {
      font-size: 4vw;
      max-font-size: 20px;
      margin: 5px 0 15px 0;
      word-break: break-word;
    }
    #info {
      font-size: 4vw;
      max-font-size: 18px;
      margin-top:10px;
    }
    button {
      font-size: 4vw;
      max-font-size: 18px;
      padding: 8px 16px;
      margin-top: 10px;
    }
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>ğŸ§­ ì‹¤ì‹œê°„ ìˆ˜í”¼ë°”ë¼ì˜ ë°©í–¥ ğŸ‰</h2>
  <div id="targetCoord">ëª©í‘œ ì¢Œí‘œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div id="arrow">â¬†ï¸</div>
  <div id="info"></div>
  <button onclick="requestPermission()">ğŸ iOS ê¶Œí•œ ìš”ì²­</button>

<script>
  // ===== Firebase ì„¤ì • (ë³¸ì¸ í”„ë¡œì íŠ¸ë¡œ ë³€ê²½) =====
  const firebaseConfig = {
    apiKey: "AIzaSyAOHwpN6pTIgFK2RkxYMNoCnkXaotTg6bY",
    authDomain: "retrofittester-4f36c.firebaseapp.com",
    databaseURL: "https://retrofittester-4f36c-default-rtdb.firebaseio.com",
    projectId: "retrofittester-4f36c",
    storageBucket: "retrofittester-4f36c.firebasestorage.app",
    messagingSenderId: "398490449949",
    appId: "1:398490449949:web:65fee5344c68ccb078aef4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let target = { lat: 37.5662952, lng: 126.9779451 }; // ì´ˆê¸°ê°’ ì„œìš¸ì‹œì²­
  let currentPos = null;
  let currentHeading = 0;

  // ===== iOS ê¶Œí•œ ìš”ì²­ =====
  function requestPermission() {
    if (DeviceOrientationEvent.requestPermission) {
      DeviceOrientationEvent.requestPermission().then(res => {
        if (res === "granted") {
          window.addEventListener("deviceorientationabsolute", handleOrientation, true);
        }
      });
    }
  }

  // ===== Android ì—¬ë¶€ ì²´í¬ =====
  const isAndroid = /Android/i.test(navigator.userAgent);

  // ===== í† ìŠ¤íŠ¸ ë©”ì‹œì§€ =====
  function showToast(message) {
    let existing = document.getElementById("toastMsg");
    if (existing) existing.remove();

    const toast = document.createElement("div");
    toast.id = "toastMsg";
    toast.innerText = message;
    toast.style.position = "fixed";
    toast.style.bottom = "50px";
    toast.style.left = "50%";
    toast.style.transform = "translateX(-50%)";
    toast.style.backgroundColor = "rgba(0,0,0,0.7)";
    toast.style.color = "#fff";
    toast.style.padding = "10px 20px";
    toast.style.borderRadius = "10px";
    toast.style.fontSize = "16px";
    toast.style.zIndex = "9999";
    toast.style.opacity = "0";
    toast.style.transition = "opacity 0.3s";
    document.body.appendChild(toast);

    setTimeout(() => { toast.style.opacity = "1"; }, 50);
    setTimeout(() => {
      toast.style.opacity = "0";
      setTimeout(() => toast.remove(), 300);
    }, 2000);
  }

  // ===== ìœ„ì¹˜ ì—…ë¡œë“œ (Android ì „ìš©) =====
  function uploadLocation() {
    if (!currentPos) return;
    firebase.database().ref("locations/userA").set({
      lat: currentPos.lat,
      lng: currentPos.lng
    }).then(() => {
      console.log("Android ìœ„ì¹˜ ì—…ë¡œë“œ ì™„ë£Œ:", currentPos.lat, currentPos.lng);
      showToast("ìœ„ì¹˜ ì—…ë°ì´íŠ¸ ì™„ë£Œ âœ…");
    }).catch(err => console.error(err));
  }

  // ===== ë‚´ ìœ„ì¹˜ ì—…ë°ì´íŠ¸ =====
  navigator.geolocation.watchPosition(pos => {
    currentPos = {
      lat: pos.coords.latitude,
      lng: pos.coords.longitude
    };

    if (isAndroid) uploadLocation();
  }, err => console.error(err), { enableHighAccuracy:true });

  // ===== Firebaseì—ì„œ ì‹¤ì‹œê°„ ëª©í‘œ ì¢Œí‘œ ê°€ì ¸ì˜¤ê¸° =====
  const targetRef = db.ref("locations/userA");
  targetRef.on("value", snapshot => {
    const data = snapshot.val();
    if (data && data.lat && data.lng) {
      target.lat = data.lat;
      target.lng = data.lng;
      document.getElementById("targetCoord").innerText = 
        `ëª©í‘œ ì¢Œí‘œ: (${target.lat.toFixed(5)}, ${target.lng.toFixed(5)})`;
    } else {
      document.getElementById("targetCoord").innerText = "ëª©í‘œ ì¢Œí‘œ ì—†ìŒ";
    }
  });

  // ===== ê¸°ê¸° ë°©í–¥ ì´ë²¤íŠ¸ =====
  window.addEventListener("deviceorientationabsolute", handleOrientation, true);
  window.addEventListener("deviceorientation", handleOrientation, true);

  function handleOrientation(event) {
    let heading;
    if (event.webkitCompassHeading) {
      heading = event.webkitCompassHeading;
    } else if (event.absolute && event.alpha !== null) {
      heading = 360 - event.alpha;
    }
    if (heading !== undefined) {
      currentHeading = heading;
      updateArrow();
    }
  }

  function updateArrow() {
    if (!currentPos || !target.lat) return;
    const bearing = computeBearing(currentPos, target);
    let diff = (bearing - currentHeading + 360) % 360;
    document.getElementById("arrow").style.transform = `rotate(${diff}deg)`;
    document.getElementById("info").innerText = 
      `ë‚˜ì¹¨ë°˜:${currentHeading.toFixed(1)}Â° / ëª©í‘œ:${bearing.toFixed(1)}Â° / í™”ì‚´í‘œ:${diff.toFixed(1)}Â°`;
  }

  function computeBearing(from, to) {
    const Ï†1 = from.lat * Math.PI/180;
    const Ï†2 = to.lat * Math.PI/180;
    const Î”Î» = (to.lng - from.lng) * Math.PI/180;
    const y = Math.sin(Î”Î») * Math.cos(Ï†2);
    const x = Math.cos(Ï†1)*Math.sin(Ï†2) -
              Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
    const Î¸ = Math.atan2(y, x);
    return (Î¸*180/Math.PI + 360) % 360;
  }
</script>
</body>
</html>
