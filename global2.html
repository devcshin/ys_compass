<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Firebase Target Compass</title>
  <style>
    body { text-align: center; font-family: sans-serif; }
    #arrow { width: 100px; margin-top: 50px; transition: transform 0.2s linear; }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js"></script>
</head>
<body>
  <h1>타겟 좌표 나침반</h1>
  <button onclick="uploadMyLocation()">내 위치 업로드</button>
  <p id="status">타겟 좌표 불러오는 중...</p>
  <img id="arrow" src="https://upload.wikimedia.org/wikipedia/commons/thumb/0/0e/Basic_arrow.svg/1200px-Basic_arrow.svg.png" />

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getDatabase, ref, set, get, child, onValue } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";

    // 🔹 Firebase 설정 (본인 프로젝트 값으로 바꾸세요)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT.firebaseapp.com",
      databaseURL: "https://YOUR_PROJECT.firebaseio.com",
      projectId: "YOUR_PROJECT",
      storageBucket: "YOUR_PROJECT.appspot.com",
      messagingSenderId: "SENDER_ID",
      appId: "APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const targetRef = ref(db, "target");

    // 🔹 내 위치를 Firebase에 업로드
    window.uploadMyLocation = function () {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          set(targetRef, { lat, lng });
          document.getElementById("status").innerText = `내 좌표 업로드됨 (${lat}, ${lng})`;
        });
      }
    };

    // 🔹 Firebase에서 타겟 좌표 실시간 불러오기
    let targetLat = null, targetLng = null;
    onValue(targetRef, (snapshot) => {
      const data = snapshot.val();
      if (data) {
        targetLat = data.lat;
        targetLng = data.lng;
        document.getElementById("status").innerText = `타겟: (${targetLat}, ${targetLng})`;
      }
    });

    // 🔹 나침반 기능
    window.addEventListener("deviceorientationabsolute", handleOrientation, true);
    window.addEventListener("deviceorientation", handleOrientation, true);

    function handleOrientation(event) {
      if (targetLat === null || targetLng === null) return;

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;
          const heading = event.alpha; // 기기의 북쪽 기준 회전각
          const bearing = computeBearing(lat, lng, targetLat, targetLng);
          const angle = bearing - heading;
          document.getElementById("arrow").style.transform = `rotate(${angle}deg)`;
        });
      }
    }

    // 🔹 두 좌표 간 방위각 계산
    function computeBearing(lat1, lng1, lat2, lng2) {
      const toRad = (deg) => deg * Math.PI / 180;
      const toDeg = (rad) => rad * 180 / Math.PI;
      const dLng = toRad(lng2 - lng1);
      const y = Math.sin(dLng) * Math.cos(toRad(lat2));
      const x = Math.cos(toRad(lat1)) * Math.sin(toRad(lat2)) -
                Math.sin(toRad(lat1)) * Math.cos(toRad(lat2)) * Math.cos(dLng);
      return (toDeg(Math.atan2(y, x)) + 360) % 360;
    }
  </script>
</body>
</html>
