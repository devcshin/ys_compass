<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>실시간 목표 방향 화살표</title>
  <style>
    body { text-align:center; font-family:sans-serif; }
    #arrow {
      font-size: 100px;
      transition: transform 0.2s linear;
      display: inline-block;
    }
    #targetCoord {
      font-size: 16px;
      margin: 5px 0 15px 0;
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>실시간 수피바라의 방향 🍉</h2>
  <div id="targetCoord">수피바라 좌표 불러오는 중...</div>
  <div id="arrow">⬆️</div>
  <div id="info"></div>
  <button onclick="requestPermission()">iOS 권한 요청</button>

<script>
  // ===== Firebase 설정 (본인 프로젝트로 변경) =====
  const firebaseConfig = {
    apiKey: "AIzaSyAOHwpN6pTIgFK2RkxYMNoCnkXaotTg6bY",
    authDomain: "retrofittester-4f36c.firebaseapp.com",
    databaseURL: "https://retrofittester-4f36c-default-rtdb.firebaseio.com",
    projectId: "retrofittester-4f36c",
    storageBucket: "retrofittester-4f36c.firebasestorage.app",
    messagingSenderId: "398490449949",
    appId: "1:398490449949:web:65fee5344c68ccb078aef4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let target = { lat: 37.5662952, lng: 126.9779451 }; // 초기값 서울시청
  let currentPos = null;
  let currentHeading = 0;

  // ===== iOS 권한 요청 =====
  function requestPermission() {
    if (DeviceOrientationEvent.requestPermission) {
      DeviceOrientationEvent.requestPermission().then(res => {
        if (res === "granted") {
          window.addEventListener("deviceorientationabsolute", handleOrientation, true);
        }
      });
    }
  }

  // ===== 위치 업데이트 (내 위치) =====
  navigator.geolocation.watchPosition(pos => {
    currentPos = {
      lat: pos.coords.latitude,
      lng: pos.coords.longitude
    };
  }, err => console.error(err), { enableHighAccuracy:true });

  // ===== Firebase에서 실시간 목표 좌표 불러오기 =====
  const targetRef = db.ref("locations/userA"); // userA 위치를 목표로
  targetRef.on("value", snapshot => {
    const data = snapshot.val();
    if (data && data.lat && data.lng) {
      target.lat = data.lat;
      target.lng = data.lng;
      // 제목 아래에 표시
      document.getElementById("targetCoord").innerText = 
        `목표 좌표: (${target.lat.toFixed(5)}, ${target.lng.toFixed(5)})`;
    } else {
      document.getElementById("targetCoord").innerText = "목표 좌표 없음";
    }
  });

  // ===== 기기 방향 이벤트 =====
  window.addEventListener("deviceorientationabsolute", handleOrientation, true);
  window.addEventListener("deviceorientation", handleOrientation, true);

  function handleOrientation(event) {
    let heading;
    if (event.webkitCompassHeading) {
      heading = event.webkitCompassHeading; // iOS (북쪽 기준)
    } else if (event.absolute && event.alpha !== null) {
      heading = 360 - event.alpha; // Android (대략적 보정, 북쪽 기준)
    }
    if (heading !== undefined) {
      currentHeading = heading;
      updateArrow();
    }
  }

  function updateArrow() {
    if (!currentPos || !target.lat) return;
    const bearing = computeBearing(currentPos, target);
    let diff = (bearing - currentHeading + 360) % 360;
    document.getElementById("arrow").style.transform = `rotate(${diff}deg)`;
    document.getElementById("info").innerText = 
      `나침반:${currentHeading.toFixed(1)}° / 목표:${bearing.toFixed(1)}° / 화살표:${diff.toFixed(1)}°`;
  }

  // ===== 두 좌표 사이 방위각 계산 =====
  function computeBearing(from, to) {
    const φ1 = from.lat * Math.PI/180;
    const φ2 = to.lat * Math.PI/180;
    const Δλ = (to.lng - from.lng) * Math.PI/180;
    const y = Math.sin(Δλ) * Math.cos(φ2);
    const x = Math.cos(φ1)*Math.sin(φ2) -
              Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
    const θ = Math.atan2(y, x);
    return (θ*180/Math.PI + 360) % 360;
  }
</script>
</body>
</html>
