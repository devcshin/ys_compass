<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì‹¤ì‹œê°„ ëª©í‘œ ë°©í–¥ í™”ì‚´í‘œ</title>
  <style>
    body { text-align:center; font-family:sans-serif; }
    #arrow {
      font-size: 100px;
      transition: transform 0.2s linear;
      display: inline-block;
    }
    #targetCoord {
      font-size: 16px;
      margin: 5px 0 15px 0;
    }
  </style>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.1.0/firebase-database-compat.js"></script>
</head>
<body>
  <h2>ì‹¤ì‹œê°„ ìˆ˜í”¼ë°”ë¼ì˜ ë°©í–¥ ğŸ‰</h2>
  <div id="targetCoord">ìˆ˜í”¼ë°”ë¼ ì¢Œí‘œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
  <div id="arrow">â¬†ï¸</div>
  <div id="info"></div>
  <button onclick="requestPermission()">iOS ê¶Œí•œ ìš”ì²­</button>

<script>
  // ===== Firebase ì„¤ì • (ë³¸ì¸ í”„ë¡œì íŠ¸ë¡œ ë³€ê²½) =====
  const firebaseConfig = {
    apiKey: "AIzaSyAOHwpN6pTIgFK2RkxYMNoCnkXaotTg6bY",
    authDomain: "retrofittester-4f36c.firebaseapp.com",
    databaseURL: "https://retrofittester-4f36c-default-rtdb.firebaseio.com",
    projectId: "retrofittester-4f36c",
    storageBucket: "retrofittester-4f36c.firebasestorage.app",
    messagingSenderId: "398490449949",
    appId: "1:398490449949:web:65fee5344c68ccb078aef4"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let target = { lat: 37.5662952, lng: 126.9779451 }; // ì´ˆê¸°ê°’ ì„œìš¸ì‹œì²­
  let currentPos = null;
  let currentHeading = 0;

  // ===== iOS ê¶Œí•œ ìš”ì²­ =====
  function requestPermission() {
    if (DeviceOrientationEvent.requestPermission) {
      DeviceOrientationEvent.requestPermission().then(res => {
        if (res === "granted") {
          window.addEventListener("deviceorientationabsolute", handleOrientation, true);
        }
      });
    }
  }

  // ===== ìœ„ì¹˜ ì—…ë°ì´íŠ¸ (ë‚´ ìœ„ì¹˜) =====
  navigator.geolocation.watchPosition(pos => {
    currentPos = {
      lat: pos.coords.latitude,
      lng: pos.coords.longitude
    };
  }, err => console.error(err), { enableHighAccuracy:true });

  // ===== Firebaseì—ì„œ ì‹¤ì‹œê°„ ëª©í‘œ ì¢Œí‘œ ë¶ˆëŸ¬ì˜¤ê¸° =====
  const targetRef = db.ref("locations/userA"); // userA ìœ„ì¹˜ë¥¼ ëª©í‘œë¡œ
  targetRef.on("value", snapshot => {
    const data = snapshot.val();
    if (data && data.lat && data.lng) {
      target.lat = data.lat;
      target.lng = data.lng;
      // ì œëª© ì•„ë˜ì— í‘œì‹œ
      document.getElementById("targetCoord").innerText = 
        `ëª©í‘œ ì¢Œí‘œ: (${target.lat.toFixed(5)}, ${target.lng.toFixed(5)})`;
    } else {
      document.getElementById("targetCoord").innerText = "ëª©í‘œ ì¢Œí‘œ ì—†ìŒ";
    }
  });

  // ===== ê¸°ê¸° ë°©í–¥ ì´ë²¤íŠ¸ =====
  window.addEventListener("deviceorientationabsolute", handleOrientation, true);
  window.addEventListener("deviceorientation", handleOrientation, true);

  function handleOrientation(event) {
    let heading;
    if (event.webkitCompassHeading) {
      heading = event.webkitCompassHeading; // iOS (ë¶ìª½ ê¸°ì¤€)
    } else if (event.absolute && event.alpha !== null) {
      heading = 360 - event.alpha; // Android (ëŒ€ëµì  ë³´ì •, ë¶ìª½ ê¸°ì¤€)
    }
    if (heading !== undefined) {
      currentHeading = heading;
      updateArrow();
    }
  }

  function updateArrow() {
    if (!currentPos || !target.lat) return;
    const bearing = computeBearing(currentPos, target);
    let diff = (bearing - currentHeading + 360) % 360;
    document.getElementById("arrow").style.transform = `rotate(${diff}deg)`;
    document.getElementById("info").innerText = 
      `ë‚˜ì¹¨ë°˜:${currentHeading.toFixed(1)}Â° / ëª©í‘œ:${bearing.toFixed(1)}Â° / í™”ì‚´í‘œ:${diff.toFixed(1)}Â°`;
  }

  // ===== ë‘ ì¢Œí‘œ ì‚¬ì´ ë°©ìœ„ê° ê³„ì‚° =====
  function computeBearing(from, to) {
    const Ï†1 = from.lat * Math.PI/180;
    const Ï†2 = to.lat * Math.PI/180;
    const Î”Î» = (to.lng - from.lng) * Math.PI/180;
    const y = Math.sin(Î”Î») * Math.cos(Ï†2);
    const x = Math.cos(Ï†1)*Math.sin(Ï†2) -
              Math.sin(Ï†1)*Math.cos(Ï†2)*Math.cos(Î”Î»);
    const Î¸ = Math.atan2(y, x);
    return (Î¸*180/Math.PI + 360) % 360;
  }
</script>
</body>
</html>
